<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAGA MOBIL | V10</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --accent: #2563eb; --bg: #09090b; --card: #18181b; --text: #f4f4f5; --border: #27272a; --input: #000000; }
        
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 110px; -webkit-tap-highlight-color: transparent; transition: 0.3s; overflow-x: hidden; }
        
        .glass { background: var(--card); border: 1px solid var(--border); border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: 0.3s; position: relative; overflow: hidden; }
        .input-pro { background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 12px; width: 100%; outline: none; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .input-pro:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        .btn-action { width: 100%; padding: 16px; background: var(--accent); color: white; border-radius: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; border:none; }
        
        #splash-screen { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        
        .dock-container { position: fixed; bottom: 20px; left: 15px; right: 15px; z-index: 1000; }
        .dock { height: 75px; background: rgba(24, 24, 27, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; display: flex; align-items: center; padding: 0 10px; overflow-x: auto; gap: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); scrollbar-width: none; }
        .dock-item { min-width: 65px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #71717a; transition: 0.3s; cursor: pointer; height: 100%; border-radius: 15px; }
        .dock-item.active { color: var(--accent); background: rgba(37, 99, 235, 0.1); }
        .dock-item span { font-size: 8px; font-weight: 800; margin-top: 3px; text-transform: uppercase; }

        .page-content { display: none; padding: 20px; animation: fadeIn 0.3s ease; padding-bottom: 120px; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .preview-wrapper { width: 100%; overflow-x: auto; background: #333; padding: 20px; border-radius: 15px; display: flex; justify-content: center; margin-bottom: 20px; }
        .sheet-a4 { width: 210mm; min-height: 297mm; background: white; color: black; padding: 15mm; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform-origin: top center; transform: scale(0.40); margin-bottom: -160mm; }
        
        .label-design { background: white; color: black; border: 4px solid black; padding: 25px; page-break-inside: avoid; margin-bottom: 20px; position: relative; width: 100%; max-width: 500px; }
        
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-calc { background: var(--input); padding: 18px 0; border-radius: 12px; font-size: 1.4rem; font-weight: 700; color: var(--text); border: 1px solid var(--border); }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <section id="splash-screen">
        <div class="text-center">
            <h1 class="text-6xl font-black italic text-blue-600 tracking-tighter mb-2">SAGA MOBIL</h1>
            <p class="text-xs font-bold uppercase tracking-[6px] opacity-60 mb-8">EN NICHOLL´S TACTICA S.A.S</p>
            <button onclick="enterApp()" class="bg-white text-black px-8 py-3 rounded-full font-black text-sm hover:scale-105 transition shadow-lg flex items-center gap-2 mx-auto">
                ABRIR SISTEMA <i data-lucide="arrow-right" class="w-4"></i>
            </button>
        </div>
    </section>

    <div class="dock-container hidden" id="main-dock">
        <nav class="dock">
            <div onclick="nav('dash')" class="dock-item active" id="n-dash"><i data-lucide="layout-grid"></i><span>Panel</span></div>
            <div onclick="nav('shelf')" class="dock-item" id="n-shelf"><i data-lucide="package"></i><span>Bodega</span></div>
            <div onclick="nav('remi')" class="dock-item" id="n-remi"><i data-lucide="file-text"></i><span>Remisión</span></div>
            <div onclick="nav('label')" class="dock-item" id="n-label"><i data-lucide="tag"></i><span>Rótulos</span></div>
            <div onclick="nav('hist')" class="dock-item" id="n-hist"><i data-lucide="history"></i><span>Historial</span></div>
            <div onclick="nav('tasks')" class="dock-item" id="n-tasks"><i data-lucide="check-square"></i><span>Tareas</span></div>
            <div onclick="nav('calc')" class="dock-item" id="n-calc"><i data-lucide="calculator"></i><span>Calc</span></div>
        </nav>
    </div>

    <div id="modal-firma" class="fixed inset-0 bg-black/90 z-[3000] hidden flex-col justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl overflow-hidden w-full max-w-md mx-auto">
            <div class="p-4 bg-zinc-100 flex justify-between items-center border-b">
                <h3 class="font-black text-black">FIRMA DIGITAL</h3>
                <button onclick="document.getElementById('modal-firma').style.display='none'" class="text-zinc-500"><i data-lucide="x"></i></button>
            </div>
            <canvas id="canvas-firma" class="w-full h-64 bg-white cursor-crosshair touch-none"></canvas>
            <div class="p-4 bg-zinc-100 flex gap-2">
                <button onclick="sigPad.clear()" class="flex-1 py-3 text-red-500 font-bold text-sm">BORRAR</button>
                <button onclick="guardarFirma()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <main id="app-content" class="hidden">
        
        <section id="sec-dash" class="page-content active">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-black italic text-blue-600 tracking-tighter">SAGA <span class="text-zinc-500 font-light">V15</span></h1>
                    <p class="text-[10px] font-bold uppercase tracking-[3px] opacity-60">Control de Inventario</p>
                </div>
            </header>

            <div class="glass p-5 space-y-4">
                <div class="flex p-1 bg-zinc-800/40 rounded-xl mb-2">
                    <button id="btn-ent" onclick="setOp('ENTRADA')" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-black text-xs transition-all">ENTRADA</button>
                    <button id="btn-sal" onclick="setOp('SALIDA')" class="flex-1 py-2 rounded-lg text-zinc-500 font-black text-xs transition-all">SALIDA</button>
                </div>

                <div class="space-y-3">
                    <input type="text" id="m-prod" placeholder="PRODUCTO" class="input-pro" list="list-prods">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="m-cant" placeholder="CANTIDAD" class="input-pro">
                        <input type="text" id="m-uni" placeholder="UNIDAD (m, kg, und)" class="input-pro">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="m-proc" placeholder="PROCESO" class="input-pro">
                        <input type="text" id="m-emp" placeholder="EMPRESA" class="input-pro">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="m-oc" placeholder="ORDEN COMPRA (OC)" class="input-pro">
                        <select id="m-loc" class="input-pro">
                            <option value="PASILLO A">PASILLO A</option>
                            <option value="PASILLO B">PASILLO B</option>
                            <option value="OFICINA">OFICINA</option>
                            <option value="EXTERIOR">EXTERIOR</option>
                        </select>
                    </div>
                </div>
                <button onclick="registrar()" class="btn-action bg-blue-600 shadow-lg shadow-blue-900/20">GUARDAR REGISTRO</button>
            </div>

            <div class="grid grid-cols-3 gap-2 mt-6">
                <div class="glass p-3 text-center border-b-2 border-blue-500">
                    <h2 id="kpi-stock" class="text-lg font-black">0</h2>
                    <p class="text-[7px] font-bold uppercase opacity-50 tracking-tighter">Stock Total</p>
                </div>
                <div class="glass p-3 text-center border-b-2 border-green-500">
                    <h2 id="kpi-movs" class="text-lg font-black">0</h2>
                    <p class="text-[7px] font-bold uppercase opacity-50 tracking-tighter">Movs Hoy</p>
                </div>
                <div class="glass p-3 text-center border-b-2 border-orange-500">
                    <h2 id="kpi-pend" class="text-lg font-black">0</h2>
                    <p class="text-[7px] font-bold uppercase opacity-50 tracking-tighter">Tareas</p>
                </div>
            </div>
        </section>

        <section id="sec-shelf" class="page-content">
            <h2 class="text-2xl font-black mb-4 italic text-blue-600">Bodega</h2>
            <div class="search-bar relative mb-4">
                <input type="text" id="search-shelf" oninput="renderShelf()" placeholder="Buscar producto..." class="input-pro pl-10">
                <i data-lucide="search" class="absolute left-3 top-3 w-5 text-zinc-500"></i>
            </div>
            <div id="shelf-view" class="space-y-3"></div>
        </section>

        <section id="sec-remi" class="page-content">
            <h2 class="text-2xl font-black mb-4 italic text-blue-600">Generador de Remisión</h2>
            <div class="glass p-5 mb-6 space-y-3">
                <input type="text" id="r-cli" placeholder="Nombre Cliente / Empresa" class="input-pro font-bold" oninput="updatePreview()">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="r-nit" placeholder="NIT / Cédula" class="input-pro" oninput="updatePreview()">
                    <input type="text" id="r-tel" placeholder="Ciudad / Tel" class="input-pro" oninput="updatePreview()">
                </div>
                <div class="p-4 bg-blue-500/5 border border-dashed border-blue-500/30 rounded-xl">
                    <div class="flex gap-2">
                        <input type="text" id="r-item" placeholder="Producto" class="input-pro flex-[3]" list="list-prods">
                        <input type="number" id="r-q" placeholder="Cant" class="input-pro flex-1">
                        <button onclick="addItemRem()" class="bg-blue-600 text-white rounded-xl w-10 font-black text-xl">+</button>
                    </div>
                </div>
                <button onclick="abrirFirma()" class="w-full py-3 bg-zinc-800 text-white rounded-xl font-bold text-[10px] tracking-widest">AÑADIR FIRMA DIGITAL</button>
            </div>

            <div class="preview-wrapper">
                <div id="remi-sheet" class="sheet-a4 relative bg-white">
                    <div class="flex justify-between items-start border-b-[8px] border-blue-900 pb-6 mb-8">
                        <div>
                            <h1 class="text-4xl font-black text-blue-900 leading-none">NICHOLL'S<br>TACTICA S.A.S.</h1>
                            <p class="text-[10px] mt-2 font-bold tracking-[3px] text-zinc-400 uppercase">FUSAGASUGA/COLOMBIA</p>
                        </div>
                        <div class="text-right">
                            <div class="bg-blue-900 text-white px-4 py-2 rounded-lg inline-block mb-2"><h2 class="text-xl font-black">REMISIÓN</h2></div>
                            <p class="text-2xl text-red-600 font-mono font-bold">N° <span id="pv-num">0000</span></p>
                            <p class="text-[10px] text-zinc-500 font-bold" id="pv-fecha"></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-8 mb-8 bg-zinc-50 p-6 rounded-2xl border border-zinc-100">
                        <div>
                            <p class="text-[9px] font-black text-blue-900 uppercase mb-1">CLIENTE / DESTINATARIO</p>
                            <p class="text-lg font-black uppercase text-zinc-800" id="pv-cli">---</p>
                            <p class="text-sm font-medium text-zinc-500">ID: <span id="pv-nit" class="font-bold">---</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-black text-blue-900 uppercase mb-1">ORIGEN</p>
                            <p class="text-sm font-bold text-zinc-800 uppercase">BODEGA PRINCIPAL</p>
                            <p class="text-sm text-zinc-500 font-medium">Fusagasugá, Cundinamarca</p>
                        </div>
                    </div>
                    <table class="w-full mb-12">
                        <thead><tr class="bg-blue-900 text-white"><th class="p-3 text-left text-[10px] rounded-l-lg">CANT</th><th class="p-3 text-left text-[10px] rounded-r-lg">DESCRIPCIÓN</th></tr></thead>
                        <tbody id="pv-items" class="divide-y divide-zinc-200"></tbody>
                    </table>
                    <div class="mt-20 grid grid-cols-2 gap-20 px-10">
                        <div class="border-t-2 border-zinc-300 pt-4 text-center">
                            <p class="text-[10px] font-black text-zinc-400 uppercase">DESPACHADO POR</p>
                            <p class="text-sm font-bold mt-2">JULIAN ACOSTA</p>
                        </div>
                        <div class="border-t-2 border-blue-900 pt-4 text-center relative">
                            <img id="pv-sign-img" class="absolute -top-16 left-0 right-0 h-16 object-contain hidden mx-auto">
                            <p class="text-[10px] font-black text-blue-900 uppercase">RECIBIDO CONFORME</p>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="saveRemision()" class="btn-action">DESCARGAR REMISIÓN (PDF)</button>
        </section>

        <section id="sec-label" class="page-content">
            <h2 class="text-2xl font-black mb-4 italic text-emerald-600">Rótulos Pro</h2>
            <div class="glass p-5 space-y-3 mb-6">
                <input type="text" id="l-dest" placeholder="DESTINATARIO (CLIENTE)" class="input-pro uppercase font-black" oninput="updateLabelPreview()">
                <div class="p-3 bg-emerald-500/5 border border-dashed border-emerald-500/30 rounded-xl">
                    <p class="text-[9px] font-black text-emerald-600 mb-2">AGREGAR CONTENIDO AL BULTO:</p>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="l-item" placeholder="Producto" class="input-pro flex-[2]" list="list-prods">
                        <input type="number" id="l-q" placeholder="Cant" class="input-pro flex-1">
                        <button onclick="addItemLabel()" class="bg-emerald-600 text-white rounded-xl w-10 font-black">+</button>
                    </div>
                    <div id="l-temp-list" class="flex flex-wrap gap-1"></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <input type="text" id="l-caja" placeholder="Caja #" class="input-pro text-center" oninput="updateLabelPreview()">
                    <input type="text" id="l-total" placeholder="De #" class="input-pro text-center" oninput="updateLabelPreview()">
                    <input type="text" id="l-peso" placeholder="Kg" class="input-pro text-center" oninput="updateLabelPreview()">
                </div>
                <div class="mt-4 p-4 bg-white rounded-xl border-2 border-zinc-200 shadow-inner">
                    <div id="live-label-preview" class="label-design mx-auto transform scale-[0.6] -my-14">
                        <div class="bg-black text-white text-center font-black p-2 mb-2 text-[10px]">ALMACEN NICHOLL´S TACTICA S.A.S</div>
                        <p class="text-[8px] font-bold text-gray-400">DESTINATARIO:</p>
                        <h1 id="lp-dest" class="text-2xl font-black mb-2 uppercase leading-none">---</h1>
                        <p class="text-[8px] font-bold text-gray-400">CONTENIDO:</p>
                        <div id="lp-cont" class="text-[9px] font-bold mb-2 uppercase min-h-[40px] whitespace-pre-wrap">---</div>
                        <div class="flex border-t-2 border-black pt-1">
                            <div class="flex-1"><p class="text-[8px]">CAJA</p><p id="lp-box" class="text-lg font-black">1/1</p></div>
                            <div class="flex-1 text-right"><p class="text-[8px]">PESO</p><p id="lp-weight" class="text-lg font-black">-- KG</p></div>
                        </div>
                    </div>
                </div>
                <button onclick="addLabel()" class="btn-action bg-emerald-600">AÑADIR A COLA</button>
            </div>
            <div id="print-area"><div id="labels-container" class="space-y-4"></div></div>
            <button onclick="window.print()" class="btn-action mt-4 bg-zinc-800">IMPRIMIR TODOS LOS RÓTULOS</button>
        </section>

        <section id="sec-hist" class="page-content">
            <h2 class="text-2xl font-black mb-4 italic text-zinc-500">Historial Detallado</h2>
            <div id="hist-list" class="space-y-3"></div>
        </section>

        <section id="sec-tasks" class="page-content">
            <h2 class="text-2xl font-black mb-4 italic text-blue-500">Tareas</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="task-input" placeholder="¿Qué hay que hacer?" class="input-pro">
                <button onclick="addTask()" class="bg-blue-600 text-white rounded-xl w-14 font-black text-xl">+</button>
            </div>
            <div id="tasks-list" class="space-y-2"></div>
        </section>

        <section id="sec-calc" class="page-content">
            <h2 class="text-2xl font-black mb-4 italic">Calculadora</h2>
            <div class="glass p-6">
                <div class="bg-black p-4 rounded-xl mb-4 text-right overflow-hidden">
                    <p id="calc-hist" class="text-xs opacity-50 h-4"></p>
                    <p id="calc-res" class="text-4xl font-mono font-black">0</p>
                </div>
                <div class="calc-grid">
                    <button class="btn-calc text-red-500" onclick="cAction('C')">C</button>
                    <button class="btn-calc" onclick="cAction('DEL')">←</button>
                    <button class="btn-calc text-blue-500" onclick="cInput('%')">%</button>
                    <button class="btn-calc text-blue-500" onclick="cInput('/')">÷</button>
                    <button class="btn-calc" onclick="cInput('7')">7</button>
                    <button class="btn-calc" onclick="cInput('8')">8</button>
                    <button class="btn-calc" onclick="cInput('9')">9</button>
                    <button class="btn-calc text-blue-500" onclick="cInput('*')">×</button>
                    <button class="btn-calc" onclick="cInput('4')">4</button>
                    <button class="btn-calc" onclick="cInput('5')">5</button>
                    <button class="btn-calc" onclick="cInput('6')">6</button>
                    <button class="btn-calc text-blue-500" onclick="cInput('-')">-</button>
                    <button class="btn-calc" onclick="cInput('1')">1</button>
                    <button class="btn-calc" onclick="cInput('2')">2</button>
                    <button class="btn-calc" onclick="cInput('3')">3</button>
                    <button class="btn-calc text-blue-500" onclick="cInput('+')">+</button>
                    <button class="btn-calc col-span-2" onclick="cInput('0')">0</button>
                    <button class="btn-calc" onclick="cInput('.')">.</button>
                    <button class="btn-calc bg-blue-600 text-white border-none" onclick="cResult()">=</button>
                </div>
            </div>
        </section>
    </main>

    <datalist id="list-prods"></datalist>

    <script>
        const DB_KEY = 'SAGA_V15_FINAL_DB';
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || { productos: [], movs: [], tasks: [], labels: [], op: 'ENTRADA' };
        let tempRem = [];
        let tempLabelItems = [];
        let sigPad;
        let calcExp = "";

        window.onload = () => {
            initSignature();
            renderAll();
            lucide.createIcons();
            document.getElementById('pv-fecha').innerText = new Date().toLocaleDateString();
        };

        function enterApp() {
            document.getElementById('splash-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('main-dock').classList.remove('hidden');
            }, 500);
        }

        const save = () => { localStorage.setItem(DB_KEY, JSON.stringify(db)); renderAll(); };

        function nav(id) {
            document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.dock-item').forEach(el => el.classList.remove('active'));
            document.getElementById('sec-' + id).classList.add('active');
            document.getElementById('n-' + id).classList.add('active');
            if(id === 'shelf') renderShelf();
            if(id === 'hist') renderHist();
            if(id === 'tasks') renderTasks();
            lucide.createIcons();
        }

        function setOp(op) {
            db.op = op;
            document.getElementById('btn-ent').className = op === 'ENTRADA' ? "flex-1 py-2 rounded-lg bg-blue-600 text-white font-black text-xs" : "flex-1 py-2 rounded-lg text-zinc-500 font-black text-xs";
            document.getElementById('btn-sal').className = op === 'SALIDA' ? "flex-1 py-2 rounded-lg bg-red-600 text-white font-black text-xs" : "flex-1 py-2 rounded-lg text-zinc-500 font-black text-xs";
        }

        function registrar() {
            const data = {
                prod: document.getElementById('m-prod').value.toUpperCase(),
                cant: parseFloat(document.getElementById('m-cant').value),
                uni: document.getElementById('m-uni').value.toUpperCase(),
                proc: document.getElementById('m-proc').value.toUpperCase(),
                emp: document.getElementById('m-emp').value.toUpperCase(),
                oc: document.getElementById('m-oc').value.toUpperCase(),
                loc: document.getElementById('m-loc').value,
                tipo: db.op,
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString(),
                ts: Date.now()
            };
            if(!data.prod || isNaN(data.cant)) return alert("Datos incompletos");
            let p = db.productos.find(x => x.nom === data.prod);
            if(!p) { p = { nom: data.prod, stk: 0, loc: data.loc }; db.productos.push(p); }
            p.stk += (db.op === 'ENTRADA' ? data.cant : -data.cant);
            p.loc = data.loc;
            db.movs.push(data);
            save();
            ['m-prod','m-cant','m-uni','m-proc','m-emp','m-oc'].forEach(i => document.getElementById(i).value = "");
            alert("Guardado");
        }

        function renderShelf() {
            const search = document.getElementById('search-shelf').value.toUpperCase();
            document.getElementById('shelf-view').innerHTML = db.productos.filter(p => p.nom.includes(search)).map(p => `
                <div class="glass p-4 flex justify-between items-center border-l-4 ${p.stk <= 0 ? 'border-red-500' : 'border-blue-500'}">
                    <div><h4 class="font-black text-sm uppercase">${p.nom}</h4><p class="text-[9px] opacity-60 font-bold">${p.loc}</p></div>
                    <span class="text-xl font-black">${p.stk}</span>
                </div>
            `).join('');
        }

        function renderHist() {
            document.getElementById('hist-list').innerHTML = db.movs.slice().reverse().map(m => `
                <div class="glass p-4 border-l-4 ${m.tipo === 'ENTRADA' ? 'border-green-500' : 'border-red-500'}">
                    <div class="flex justify-between items-start mb-2">
                        <div><span class="text-[8px] bg-zinc-800 px-2 py-1 rounded font-bold">${m.tipo}</span><h4 class="font-black text-blue-500 mt-1 uppercase text-xs">${m.prod}</h4></div>
                        <p class="font-black">${m.cant} <span class="text-[9px] opacity-50">${m.uni}</span></p>
                    </div>
                    <div class="grid grid-cols-2 gap-1 text-[8px] font-bold opacity-70">
                        <p>OC: ${m.oc || '-'}</p><p>UBICACIÓN: ${m.loc}</p><p>EMP: ${m.emp || '-'}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- REMISIÓN ---
        function initSignature() { sigPad = new SignaturePad(document.getElementById('canvas-firma')); }
        function abrirFirma() { document.getElementById('modal-firma').style.display = 'flex'; }
        function guardarFirma() {
            if(!sigPad.isEmpty()) {
                document.getElementById('pv-sign-img').src = sigPad.toDataURL();
                document.getElementById('pv-sign-img').classList.remove('hidden');
            }
            document.getElementById('modal-firma').style.display = 'none';
        }
        function addItemRem() {
            const desc = document.getElementById('r-item').value, q = document.getElementById('r-q').value;
            if(desc && q) { tempRem.push({desc, q}); document.getElementById('r-item').value = ""; document.getElementById('r-q').value = ""; updatePreview(); }
        }
        function updatePreview() {
            document.getElementById('pv-cli').innerText = document.getElementById('r-cli').value || '---';
            document.getElementById('pv-nit').innerText = document.getElementById('r-nit').value || '---';
            document.getElementById('pv-num').innerText = Date.now().toString().slice(-4);
            document.getElementById('pv-items').innerHTML = tempRem.map(i => `<tr><td class="p-3 font-bold text-blue-900">${i.q}</td><td class="p-3 uppercase text-zinc-700 text-xs">${i.desc}</td></tr>`).join('');
        }
        function saveRemision() {
            if(tempRem.length === 0) return alert("Sin items");
            html2pdf().set({ margin: 0, filename: `Remision_${Date.now()}.pdf`, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } }).from(document.getElementById('remi-sheet')).save();
        }

        // --- RÓTULOS ---
        function addItemLabel() {
            const p = document.getElementById('l-item').value, q = document.getElementById('l-q').value;
            if(p && q) { tempLabelItems.push(`${q} - ${p}`); document.getElementById('l-item').value = ""; document.getElementById('l-q').value = ""; renderTempLabelItems(); updateLabelPreview(); }
        }
        function renderTempLabelItems() {
            document.getElementById('l-temp-list').innerHTML = tempLabelItems.map((it, idx) => `<span class="bg-emerald-100 text-emerald-800 text-[9px] px-2 py-1 rounded font-bold flex items-center gap-1">${it} <i data-lucide="x" class="w-3 cursor-pointer" onclick="tempLabelItems.splice(${idx},1);renderTempLabelItems();updateLabelPreview();"></i></span>`).join('');
            lucide.createIcons();
        }
        function updateLabelPreview() {
            document.getElementById('lp-dest').innerText = document.getElementById('l-dest').value || '---';
            document.getElementById('lp-cont').innerText = tempLabelItems.join('\n') || '---';
            document.getElementById('lp-box').innerText = `${document.getElementById('l-caja').value || '1'}/${document.getElementById('l-total').value || '1'}`;
            document.getElementById('lp-weight').innerText = `${document.getElementById('l-peso').value || '--'} KG`;
        }
        function addLabel() {
            const dest = document.getElementById('l-dest').value.toUpperCase();
            if(!dest || tempLabelItems.length === 0) return alert("Faltan datos");
            db.labels.push({ dest, cont: tempLabelItems.join('<br>'), caja: document.getElementById('l-caja').value, total: document.getElementById('l-total').value, peso: document.getElementById('l-peso').value });
            save(); renderLabels(); tempLabelItems = []; renderTempLabelItems();
        }
        function renderLabels() {
            document.getElementById('labels-container').innerHTML = db.labels.map(l => `<div class="label-design mx-auto"><div class="bg-black text-white text-center font-black p-2 mb-4">SAGA LOGISTICS</div><p class="text-xs font-bold text-gray-400">DESTINATARIO:</p><h1 class="text-4xl font-black mb-4 uppercase">${l.dest}</h1><p class="text-xs font-bold text-gray-400">CONTENIDO:</p><div class="text-xl font-bold mb-4 uppercase">${l.cont}</div><div class="flex border-t-4 border-black pt-2"><div class="flex-1"><p class="text-xs">CAJA</p><p class="text-3xl font-black">${l.caja}/${l.total}</p></div><div class="flex-1 text-right"><p class="text-xs">PESO</p><p class="text-3xl font-black">${l.peso} KG</p></div></div></div>`).join('');
        }

        // --- OTROS ---
        function addTask() {
            const txt = document.getElementById('task-input').value; if(!txt) return;
            db.tasks.push({ id: Date.now(), txt, done: false }); document.getElementById('task-input').value = ""; save();
        }
        function renderTasks() {
            document.getElementById('tasks-list').innerHTML = db.tasks.map(t => `<div class="glass p-3 flex items-center gap-3 ${t.done ? 'opacity-50' : ''}"><input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTask(${t.id})" class="w-5 h-5"><span class="flex-1 font-bold text-sm ${t.done ? 'line-through' : ''}">${t.txt}</span></div>`).join('');
        }
        function toggleTask(id) { const t = db.tasks.find(x => x.id === id); if(t) { t.done = !t.done; save(); } }

        function cInput(v) { calcExp += v; document.getElementById('calc-hist').innerText = calcExp; }
        function cAction(a) { if(a === 'C') { calcExp = ""; document.getElementById('calc-res').innerText = "0"; } else { calcExp = calcExp.slice(0, -1); } document.getElementById('calc-hist').innerText = calcExp; }
        function cResult() { try { let res = eval(calcExp); document.getElementById('calc-res').innerText = res; calcExp = res.toString(); } catch { document.getElementById('calc-res').innerText = "Error"; } }

        function renderAll() {
            document.getElementById('kpi-stock').innerText = db.productos.reduce((a,b)=>a+b.stk, 0);
            document.getElementById('kpi-movs').innerText = db.movs.filter(m => m.fecha === new Date().toLocaleDateString()).length;
            document.getElementById('kpi-pend').innerText = db.tasks.filter(t=>!t.done).length;
            document.getElementById('list-prods').innerHTML = db.productos.map(p => `<option value="${p.nom}">`).join('');
            renderTasks(); renderLabels();
        }
    </script>
</body>
</html>
